---
- name: Install nginx deps
  apt:
    pkg:
      - "nginx"
      - "python3-certbot"
      - "cron"
      - "git"

- name: Allow connections on multiple ports
  iptables:
    chain: INPUT
    protocol: tcp
    destination_ports:
      - "80"
      - "443"
    jump: ACCEPT


- name: "place nginx conf"
  template:
    src: "../../../deployables/nginx/nginx.conf.j2"
    dest: "/etc/nginx/sites-enabled/default"
    mode: 0644

- name: "place initial certbot script"
  template:
    src: "../../../deployables/nginx/init-certbot.j2"
    dest: "/usr/sbin/init-certbot"
    mode: 0744

- name: Start and enable service
  service:
    name: nginx
    state: restarted
    enabled: true

# actually doing this as part of the play has a danger of causing
# us to get rate limited while testing
- name: remind to run initial cert
  debug:
    msg: "ssh into vm and run init-certbot on first run"
