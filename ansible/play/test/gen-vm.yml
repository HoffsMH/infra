---
- hosts: thinkcentre-a
  vars:
    ansible_host_key_checking: false
  tasks:
    - name: get qmid
      command:
        cmd: "get-avail-qm-id"
      register: qmid

    - name: get qmid
      command:
        cmd: "/infra/assets/proxmox/get-avail-qm-id"
      register: qmid

    - name: clone
      command:
        cmd: "qm clone 100 {{ qmid.stdout }} --description=test-deb --name=test-deb-{{ qmid.stdout }}"

    - name: start
      command:
        cmd: "qm start {{ qmid.stdout }}"

    - name: "get ip of newly started vm"
      command:
        cmd: "/infra/assets/proxmox/get-ip-address {{ qmid.stdout }}"
      register: qmip
      until: qmip.stdout != ""
      retries: 10
      delay: 10

    - name:
      debug:
        msg: "{{ qmip }}"

    # - name: "example test play"
    #   vars:
    #     ansible_host: "{{ qmip.stdout }}"
    #     ansible_user: root
    #     cert_email: "matthecker@pm.me"
    #   include_role:
    #     name: "../../roles/vm-nginx"
    #
    # - name: "example test play"
    #   vars:
    #     ansible_host: "{{ qmip.stdout }}"
    #     ansible_user: root
    #     repo_url: https://github.com/HoffsMH/mhkr.io
    #     static_files_dir: public
    #   include_role:
    #     name: "../../roles/static-site"
