#!/bin/bash

jrnldir=~/personal/jrnl.bak2/
jrnlfile=~/personal/jrnl.bak2/jrnl.md

pushd $jrnldir
  shred -u ./*.tar
  if [[ -f $jrnlfile ]]
  then
    # split the jrnlfile and delete it
    cat $jrnlfile | hsplit $jrnldir && shred -u $jrnlfile
    ls .
  fi

  # https://unix.stackexchange.com/questions/100871/in-a-bash-if-condition-how-to-check-whether-any-files-matching-a-simple-wildcar
  for file in $(fd -g '*.md'); do
    if [[ -f "$file" ]]; then
      echo "looking at md file $file"
      # get sum of all md files in dir
      x=$(cat "$file" | sha256sum)
      sum=${x::10}
      dateprefix=$(parsedate $file)

      # form tarname
      tarname="$dateprefix-$sum.tar"
      echo "form tarname: $tarname"
      tar -cf $tarname "$file" --force-local

      # shred and delete after in tar
      shred -u "$file"
    fi
  done

  for tarfile in $(fd -g '*.tar'); do
    if [[ -f "$tarfile" ]]; then
      echo "looking at tarfile: $tarfile"
      gpg --encrypt --recipient "matthecker@pm.me" "$tarfile"
      shred -u "$tarfile"
    fi
  done

