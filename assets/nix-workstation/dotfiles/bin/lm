#!/bin/zsh

FILE_PATH="/tmp/kitty"
HIST_FILE="$HOME/.menu-history"

[[ -p $FILE_PATH ]] || touch $FILE_PATH

ITEMS=$(mktemp)

cat $HIST_FILE > $ITEMS

eval "$(atuin init zsh)"

atuin history list | tac | awk '{for (i=3; i<=NF; i++) printf "%s ", $i; print ";"}' | awk '{gsub(/[0-9]+ms/, ""); print $0}' >> $ITEMS

~/go/bin/binlist >> $ITEMS

cat $ITEMS | dedup > $FILE_PATH

kitty -c ~/.config/kitty/kitty-menu.conf --class=kitty-menu ~/bin/tmp-fzf

cmd=$(cat $FILE_PATH)

temp_file=$(mktemp)
echo "$cmd" > $temp_file
cat $HIST_FILE >> $temp_file
mv $temp_file $HIST_FILE

rm $FILE_PATH

if [[ "$cmd" =~ \;$ ]]; then
  kitty --class=kitty-popup zshc $cmd
else
  "$cmd"
fi

