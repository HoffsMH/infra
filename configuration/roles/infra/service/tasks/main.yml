---
- name: pull down latest infra
  git:
    repo: 'https://github.com/HoffsMH/infra.git'
    dest: "/infra"
    force: yes
    version: master

- name: check if rules file exists
  stat:
    path: /infra/deployables/{{ service_name }}/Dockerfile
  register: dockerfile_present

- name: build docker
  command:
    cmd: "docker build . -t {{ service_name }}"
  when: dockerfile_present == true

- name: "place service file"
  copy:
    remote_src: true
    src: "/infra/deployables/{{ service_name }}/service"
    dest: "/etc/systemd/system/docker-{{ service_name }}.service"
    mode: 0644
    force: true

- name: reload systemctl after putting in new service file
  command:
    cmd: "systemctl daemon-reload"

- name: reset failed
  command:
    cmd: "systemctl reset-failed"

- name: Start and enable service
  service:
    name: docker-{{ service_name }}
    state: started
    enabled: true
